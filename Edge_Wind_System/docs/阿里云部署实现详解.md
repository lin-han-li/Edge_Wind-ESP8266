# Edge_Wind_System 阿里云部署实现详解（推荐：ECS + Nginx + HTTPS + systemd）

本文以 **阿里云 ECS（Ubuntu）** 为主线，给出从 0 到可用的部署步骤，并覆盖 WebSocket 反向代理、进程守护、日志、SQLite 运维（备份/清理/VACUUM）等关键点。

> 适用范围：部署 `Edge_Wind_System/`（Flask + Socket.IO + SQLite）到公网/专网服务器。  
> 下位机 STM32H7 + ESP8266 固件不在本文部署范围内（固件仍通过 HTTP 上报到该服务器）。

---

## 0. 部署方案选择（先选再做）

### 方案 A（推荐）：ECS + systemd + Gunicorn(eventlet) + Nginx

- **优点**：稳定、可控、成本低、适合 WebSocket、排障简单
- **缺点**：需要你管理服务器（更新、备份、证书续期）

### 方案 B：ECS + Docker Compose（可选）

- **优点**：环境一致、易迁移
- **缺点**：需要你熟悉 Docker；WebSocket/反代/持久化要配置好

本文主讲 **方案 A**，最后附上 **Docker Compose 参考**。

---

## 1. ECS 与网络（安全组 / 端口规划）

### 1.1 创建 ECS（建议）

- **地域**：离你的设备/用户更近
- **系统镜像**：Ubuntu 22.04 LTS（或 20.04）
- **实例规格**：2C4G 起步（节点多/频谱多再加）
- **磁盘**：系统盘 40GB+（历史曲线多就加大）

### 1.2 安全组放行

至少放行：

- TCP **22**（SSH）
- TCP **80**（HTTP，给 Nginx 用）
- TCP **443**（HTTPS，给 Nginx 用）

> 不建议直接把 Flask/Gunicorn 的 5000 端口暴露公网；让 Nginx 做统一入口即可。

如果你暂时不做 Nginx，也可以临时放行 5000：
- TCP **5000**（临时测试用，不推荐长期）

---

## 2. 服务器初始化（系统用户 / 目录 / 依赖）

以下以部署到 `/opt/edgewind` 为例。

### 2.1 SSH 登录并更新系统

```bash
sudo apt update && sudo apt -y upgrade
sudo apt -y install git curl unzip ca-certificates
```

### 2.2 创建运行用户（建议）

```bash
sudo useradd -m -s /bin/bash edgewind
sudo mkdir -p /opt/edgewind
sudo chown -R edgewind:edgewind /opt/edgewind
```

后续所有项目文件都放到 `/opt/edgewind` 下，避免散落到 root 目录。

---

## 3. 安装 Python 3.11 并创建 venv

Ubuntu 22.04 默认 Python 3.10，你可以继续用（项目在 Windows 推荐 3.11 是为 eventlet 兼容性；Linux 上 3.10/3.11 都可以）。

这里给出 **Python 3.11** 安装方式（推荐一致性）：

```bash
sudo apt -y install python3.11 python3.11-venv python3.11-dev
```

创建虚拟环境：

```bash
sudo -u edgewind bash -lc '
cd /opt/edgewind
python3.11 -m venv venv
'
```

---

## 4. 拉取代码与安装依赖

### 4.1 拉取仓库

```bash
sudo -u edgewind bash -lc '
cd /opt/edgewind
git clone <你的仓库地址> repo
'
```

项目上位机目录在：
- `/opt/edgewind/repo/Edge_Wind_System`

### 4.2 安装依赖

```bash
sudo -u edgewind bash -lc '
cd /opt/edgewind/repo/Edge_Wind_System
../venv/bin/pip install -r requirements.txt
'
```

---

## 5. 配置运行参数（edgewind.env / 管理员初始化）

建议在服务器上单独放一份环境文件，不直接改仓库里的 `edgewind.env`：

```bash
sudo -u edgewind bash -lc '
cat > /opt/edgewind/edgewind.env <<EOF
# Flask 会话密钥（务必改成随机强密钥）
SECRET_KEY=CHANGE_ME_TO_RANDOM_LONG_SECRET

# 监听端口（Gunicorn/Nginx 内部用）
HOST=127.0.0.1
PORT=5000

# 数据库（SQLite）
DATABASE_URL=sqlite:////opt/edgewind/data/instance/wind_farm.db

# SocketIO 模式（Linux 推荐 eventlet）
FORCE_ASYNC_MODE=eventlet

# 首次初始化管理员（建议显式设置）
EDGEWIND_ADMIN_USERNAME=Edge_Wind
EDGEWIND_ADMIN_INIT_PASSWORD=CHANGE_ME_STRONG_PASSWORD

# 节点超时（秒）
EDGEWIND_NODE_TIMEOUT_SEC=60

# 推送频率（按需调）
EDGEWIND_STATUS_EMIT_HZ=5
EDGEWIND_MONITOR_EMIT_HZ=20

# 降采样点数（历史曲线/波形量大时可降低）
EDGEWIND_WAVEFORM_POINTS=256
EDGEWIND_SPECTRUM_POINTS=128

# 生产环境建议限制 CORS
ALLOWED_ORIGINS=https://your.domain.com
EOF
'
```

并创建数据目录：

```bash
sudo -u edgewind bash -lc '
mkdir -p /opt/edgewind/data/instance
mkdir -p /opt/edgewind/data/logs
'
```

> 说明：项目默认会在 `Edge_Wind_System/instance/` 下创建 db；这里改成 `/opt/edgewind/data/instance/` 是为了 **代码与数据分离**，便于升级与备份。

---

## 6. 用 Gunicorn(eventlet) 启动（先手动验证）

项目提供 `wsgi.py` 与 `gunicorn_config.py`，但请注意一个关键点：

### 6.1 关于 worker 数（非常重要）

当前项目存在 `active_nodes` 等 **内存态状态**（并且不是 Redis 共享）。因此：

- **强烈建议**：`GUNICORN_WORKERS=1`
- 如果你设置多个 worker：节点状态/订阅/推送会出现“不同步、丢推送、页面看不到某些节点”等问题

### 6.2 手动启动验证

```bash
sudo -u edgewind bash -lc '
cd /opt/edgewind/repo/Edge_Wind_System
export EDGEWIND_ENV_FILE=/opt/edgewind/edgewind.env
export GUNICORN_WORKERS=1
../venv/bin/gunicorn -c gunicorn_config.py wsgi:application
'
```

保持运行后，用另一台机器/本机 curl 验证：

```bash
curl -I http://127.0.0.1:5000/
```

能返回 302/200 即说明后端起来了。

---

## 7. systemd 常驻运行（生产必做）

创建 systemd 服务：

```bash
sudo tee /etc/systemd/system/edgewind.service > /dev/null <<'EOF'
[Unit]
Description=EdgeWind (Flask-SocketIO) Service
After=network.target

[Service]
Type=simple
User=edgewind
Group=edgewind
WorkingDirectory=/opt/edgewind/repo/Edge_Wind_System

Environment=EDGEWIND_ENV_FILE=/opt/edgewind/edgewind.env
Environment=GUNICORN_WORKERS=1

ExecStart=/opt/edgewind/venv/bin/gunicorn -c gunicorn_config.py wsgi:application
Restart=always
RestartSec=2

# 日志走 journald；也可以在这里指定标准输出文件
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

启动并设置开机自启：

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now edgewind
sudo systemctl status edgewind --no-pager
```

查看日志：

```bash
sudo journalctl -u edgewind -f
```

---

## 8. Nginx 反向代理 + WebSocket（推荐对外只开 80/443）

安装 Nginx：

```bash
sudo apt -y install nginx
```

创建站点配置（将域名替换为你的域名）：

```bash
sudo tee /etc/nginx/sites-available/edgewind.conf > /dev/null <<'EOF'
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name your.domain.com;

    # 若你要先用 HTTP 验证，再上 HTTPS，可保留该段
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket (Socket.IO)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # 你的系统可能会有较大的波形数据，适当放宽
        client_max_body_size 20m;
        proxy_read_timeout 120s;
    }
}
EOF
```

启用站点并重载：

```bash
sudo ln -sf /etc/nginx/sites-available/edgewind.conf /etc/nginx/sites-enabled/edgewind.conf
sudo nginx -t
sudo systemctl reload nginx
```

此时公网访问：
- `http://your.domain.com`

---

## 9. 配置 HTTPS（Let’s Encrypt）

安装 certbot：

```bash
sudo apt -y install certbot python3-certbot-nginx
```

签发证书并自动改 Nginx 配置：

```bash
sudo certbot --nginx -d your.domain.com
```

验证续期：

```bash
sudo certbot renew --dry-run
```

> 阿里云如果使用 SLB/ALB 做 HTTPS 终止，也可以把 HTTPS 放在负载均衡层，ECS 内保持 HTTP。

---

## 10. 数据库（SQLite）运维：备份 / 清理 / VACUUM

### 10.1 SQLite 文件位置

若你按本文配置，数据库在：
- `/opt/edgewind/data/instance/wind_farm.db`

### 10.2 备份（推荐：停服务后备份）

```bash
sudo systemctl stop edgewind
sudo -u edgewind bash -lc '
mkdir -p /opt/edgewind/backups
cp -a /opt/edgewind/data/instance/wind_farm.db /opt/edgewind/backups/wind_farm.db.$(date +%F_%H%M%S)
'
sudo systemctl start edgewind
```

### 10.3 为什么删数据后文件大小不变？

SQLite 的 `DELETE` 只是把页标记为可复用，不会缩小数据库文件。要缩小文件必须执行：
- `VACUUM;`

### 10.4 在线 VACUUM（项目已提供）

你可以登录系统设置页点击：
- `回收数据库空间（VACUUM）`

它会调用后端接口：
- `POST /api/admin/vacuum_db`

> 建议在设备暂停上报时执行；如果提示 `database is locked`，说明仍有写入占用。

---

## 11. 常见问题（部署侧）

### 11.1 页面能打开但 WebSocket 不工作

优先检查：
- Nginx 是否加了 `Upgrade/Connection` 头（见本文第 8 节配置）
- 后端是否以 eventlet 模式运行：`FORCE_ASYNC_MODE=eventlet`

### 11.2 多 worker 引起节点状态异常

表现：
- 同一个节点在不同页面显示不一致、偶发丢推送

解决：
- 设置 `GUNICORN_WORKERS=1`

### 11.3 设备上报太频繁导致 CPU/IO 压力大

处理思路：
- 降低 `EDGEWIND_MONITOR_EMIT_HZ`
- 降低 `EDGEWIND_WAVEFORM_POINTS / EDGEWIND_SPECTRUM_POINTS`
- 优化下位机上报频率（或只在状态变化/故障时上报大数据）

---

## 12.（可选）Docker Compose 参考

> 仅作为参考模板，你可以按需要调整端口、挂载、环境变量。

`docker-compose.yml`（示例）：

```yaml
services:
  edgewind:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./Edge_Wind_System:/app
      - ./data:/opt/edgewind/data
    environment:
      EDGEWIND_ENV_FILE: /app/edgewind.env
      GUNICORN_WORKERS: "1"
    command: >
      bash -lc "pip install -r requirements.txt
      && gunicorn -c gunicorn_config.py wsgi:application"
    ports:
      - "5000:5000"
    restart: unless-stopped
```

你仍然建议加 Nginx 做 HTTPS / WebSocket 反代（同样的 Upgrade 头逻辑）。


{% extends "base.html" %}

{% block title %}æ•…éšœç®¡ç† - EdgeWind{% endblock %}
{% block page_title %}æ•…éšœç®¡ç†{% endblock %}

{% block content %}
<!-- æ•…éšœåˆ—è¡¨è¡¨æ ¼ -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center bg-white py-3 border-0">
        <h5 class="mb-0 fw-bold text-primary">
            <i class="bi bi-clipboard-list me-2"></i>æ•…éšœæ—¥å¿—
        </h5>
        
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm border-light bg-light" id="status-filter" style="width: 120px; font-size: 13px;" title="ç­›é€‰å·¥å•çŠ¶æ€" aria-label="ç­›é€‰å·¥å•çŠ¶æ€">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="pending">å¾…å¤„ç†</option>
                <option value="processing">å¤„ç†ä¸­</option>
                <option value="resolved">å·²è§£å†³</option>
            </select>

            <select class="form-select form-select-sm border-light bg-light" id="device-filter" style="width: 120px; font-size: 13px;" title="ç­›é€‰è®¾å¤‡" aria-label="ç­›é€‰è®¾å¤‡">
                <option value="">æ‰€æœ‰è®¾å¤‡</option>
            </select>

            <div class="input-group input-group-sm" style="width: 200px;">
                <span class="input-group-text"><i class="bi bi-search text-muted"></i></span>
                <input type="text" class="form-control" id="fault-search" placeholder="æœç´¢æ—¥å¿—..." style="font-size: 13px;">
            </div>

            <button class="btn btn-sm btn-light text-primary" onclick="refreshFaultTable()" title="åˆ·æ–°">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            
            <button class="btn btn-sm btn-outline-primary" onclick="exportData()" title="å¯¼å‡ºæ•°æ®">
                <i class="bi bi-download"></i> å¯¼å‡º
            </button>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>çŠ¶æ€</th>
                        <th>ä¸¥é‡ç¨‹åº¦</th>
                        <th>æ•…éšœæè¿°</th>
                        <th>æœºç»„</th>
                        <th>æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="fault-table-body">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- è¯Šæ–­æ¨¡æ€æ¡† -->
<div class="modal fade" id="diagnosisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ™ºèƒ½æ•…éšœè¯Šæ–­å¼•æ“</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="reset-graph-btn" onclick="resetKnowledgeGraph()">
                    <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®è§†å›¾
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="mb-3">æ•…éšœè¯¦æƒ…</h6>
                        <div id="fault-details">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h6 class="mb-3">çŸ¥è¯†å›¾è°±è¯Šæ–­</h6>
                        <div id="diagnosis-graph" style="width: 100%; height: 100%; min-height: 850px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-success" onclick="exportWorkOrder()">
                    <i class="bi bi-file-earmark-word"></i> å¯¼å‡ºå·¥å•
                </button>
                <button type="button" class="btn btn-primary" id="dispatch-fault-btn" style="display: none;">
                    <i class="bi bi-clipboard-check"></i> ç¡®è®¤æ´¾å•
                </button>
                <button type="button" class="btn btn-success" id="resolve-fault-btn" style="display: none;">
                    <i class="bi bi-check-circle"></i> ç»´ä¿®å®Œæˆ
                </button>
                <button type="button" class="btn btn-secondary" id="archived-btn" style="display: none;" disabled>
                    <i class="bi bi-archive"></i> å·²å½’æ¡£
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* ========== Modern Soft SaaS Styling ========== */
    
    /* Table Card Styling */
    .card {
        box-shadow: 0 0 40px 0 rgba(0,0,0,.05);
        border: none;
        border-radius: 12px;
        background: #fff;
    }

    /* ========== Soft Badges ========== */
    .badge {
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 11px;
        letter-spacing: 0.5px;
        border: none;
    }
    
    .badge-soft-danger {
        background-color: #ffe5e5;
        color: #d32f2f;
    }
    
    .badge-soft-warning {
        background-color: #fff8e1;
        color: #f57c00;
    }
    
    .badge-soft-success {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    
    .badge-soft-primary {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-soft-info {
        background-color: #e0f7fa;
        color: #0277bd;
    }

    /* ========== Table Styling ========== */
    .table thead th {
        border-bottom: 2px solid #f0f2f5;
        color: #8898aa;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        padding: 12px 16px;
        background: transparent;
    }
    
    .table tbody td {
        padding: 16px;
        vertical-align: middle;
        color: #525f7f;
        border-bottom: 1px solid #f5f7fa;
        font-size: 13px;
    }
    
    .table-hover tbody tr:hover {
        background-color: #fcfcfc;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.04);
        transition: all 0.2s ease;
        position: relative;
        z-index: 1;
    }

    /* ========== Spotlight Search Input ========== */
    #fault-search {
        border-radius: 20px;
        background-color: #f5f7fa;
        border: none;
        padding: 8px 16px;
        transition: all 0.3s ease;
    }
    
    #fault-search:focus {
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        border: 1px solid rgba(37, 99, 235, 0.2);
        outline: none;
    }
    
    .input-group-text {
        background-color: #f5f7fa;
        border: none;
        border-radius: 20px 0 0 20px;
    }
    
    .input-group-sm .input-group-text {
        padding-left: 16px;
    }

    /* Toolbar Inputs */
    .form-select-sm, .form-control-sm {
        border-radius: 8px;
        box-shadow: none !important;
        transition: all 0.2s;
        border: 1px solid #e9ecef;
    }

    .form-select-sm:hover, .form-control:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .form-select-sm:focus, .form-control:focus {
        background-color: #fff;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* ========== çŸ¥è¯†å›¾è°±æ¨¡æ€æ¡†æ ·å¼ ========== */
    #diagnosisModal .modal-dialog {
        max-width: 75% !important;
        width: 75% !important;
        max-height: 98vh;
        margin: 1vh auto;
    }
    
    #diagnosisModal .modal-content {
        height: 98vh !important;
        max-height: 98vh !important;
        display: flex;
        flex-direction: column;
        background: #ffffff !important;
        color: #1f2937 !important;
    }
    
    #diagnosisModal .modal-header {
        background: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
        color: #1f2937 !important;
        flex-shrink: 0;
    }
    
    #diagnosisModal .modal-title {
        color: #1f2937 !important;
        font-weight: 600;
    }
    
    #diagnosisModal .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        color: #1f2937 !important;
        background: #ffffff !important;
    }

    #diagnosisModal .modal-body .row {
        height: 100%;
    }

    #diagnosisModal .modal-body .col-md-8 {
        display: flex;
        flex-direction: column;
    }

    #diagnosisModal .modal-body .col-md-8 h6 {
        flex: 0 0 auto;
    }

    #diagnosisModal #diagnosis-graph {
        flex: 1;
    }
    
    #diagnosisModal .modal-footer {
        flex-shrink: 0;
        background: #f8f9fa !important;
        border-top: 1px solid #dee2e6 !important;
    }
    
    #diagnosisModal .modal-footer {
        background: #f8f9fa !important;
        border-top: 1px solid #dee2e6 !important;
    }
    
    /* ç¡®ä¿æ¨¡æ€æ¡†å†…æ‰€æœ‰æ–‡å­—éƒ½æ˜¯æ·±è‰² - ç‰¹åˆ«æ˜¯æ•…éšœè¯¦æƒ…éƒ¨åˆ† */
    #diagnosisModal h6,
    #diagnosisModal h5,
    #diagnosisModal h4,
    #diagnosisModal h3,
    #diagnosisModal h2,
    #diagnosisModal h1 {
        color: #1f2937 !important;
    }
    
    #diagnosisModal p,
    #diagnosisModal div,
    #diagnosisModal span,
    #diagnosisModal strong,
    #diagnosisModal code,
    #diagnosisModal small {
        color: #1f2937 !important;
    }
    
    /* æ•…éšœè¯¦æƒ…åŒºåŸŸç‰¹åˆ«å¤„ç† */
    #diagnosisModal #fault-details,
    #diagnosisModal #fault-details * {
        color: #1f2937 !important;
    }
    
    #diagnosisModal #fault-details strong {
        color: #1f2937 !important;
        font-weight: 600;
    }
    
    #diagnosisModal #fault-details code {
        background: #f3f4f6 !important;
        color: #1f2937 !important;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
    }
    
    #diagnosisModal #fault-details code.text-danger {
        color: #dc3545 !important;
    }
    
    #diagnosisModal .text-muted {
        color: #6b7280 !important;
    }
    
    #diagnosisModal .btn-close {
        filter: none;
        opacity: 0.5;
    }
    
    #diagnosisModal .btn-close:hover {
        opacity: 1;
    }

    /* Responsive adjustments for mobile */
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem;
        }
        
        .card-header .d-flex {
            width: 100%;
            flex-wrap: wrap;
        }
        
        .card-header .d-flex > * {
            flex: 1 1 auto;
            min-width: 120px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // ========== å·¥å…·å‡½æ•°ï¼ˆå¿…é¡»æ”¾åœ¨æœ¬é¡µä¸»é€»è¾‘ä¹‹å‰ï¼Œé¿å… ReferenceErrorï¼‰==========
    // è¯´æ˜ï¼šbase.html åªæ¸²æŸ“ extra_jsï¼Œä¸æ¸²æŸ“ scriptsï¼›å› æ­¤è¿™äº›å‡½æ•°å¿…é¡»åœ¨ extra_js å†…å®šä¹‰ã€‚
    function getCsrfToken() {
        const el = document.querySelector('meta[name="csrf-token"]');
        return el ? (el.getAttribute('content') || '') : '';
    }

    // å®‰å…¨ï¼šHTMLè½¬ä¹‰ï¼Œé˜²æ­¢æŠŠè®¾å¤‡/ä½ç½®/AIæ¨èç­‰å­—æ®µç›´æ¥æ‹¼è¿› innerHTML å¼•å‘ XSS
    function escapeHtml(s) {
        const str = String(s ?? '');
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    let diagnosisChart = null;
    let currentFaultId = null;
    let currentFault = null;  // å½“å‰é€‰ä¸­çš„æ•…éšœå¯¹è±¡ï¼ˆç”¨äºå¯¼å‡ºä¸­æ–‡æ–‡ä»¶åç­‰ï¼‰
    let globalFaultData = [];  // å…¨å±€å­˜å‚¨ä»APIè·å–çš„åŸå§‹æ•…éšœæ•°æ®
    let allFaults = globalFaultData;  // ä¿æŒå‘åå…¼å®¹ï¼Œä½†ä½¿ç”¨ globalFaultData
    let originalGraphData = null;  // ä¿å­˜åŸå§‹å›¾è°±æ•°æ®ï¼Œç”¨äºé‡ç½®
    let expandedNodes = new Set();  // è®°å½•å·²å±•å¼€çš„èŠ‚ç‚¹ï¼Œé¿å…é‡å¤å±•å¼€
    let previousFaultIds = null;  // å­˜å‚¨ä¸Šä¸€æ¬¡çš„æ•…éšœIDé›†åˆï¼Œç”¨äºæ£€æµ‹æ–°æ•…éšœ

    const DEFAULT_GRAPH_ZOOM = 1.35;
    const DEFAULT_GRAPH_CENTER = ['50%', '55%'];

    function applyGraphInitialView() {
        if (!diagnosisChart) return;
        diagnosisChart.setOption({
            series: [{
                zoom: DEFAULT_GRAPH_ZOOM,
                center: DEFAULT_GRAPH_CENTER
            }]
        }, { notMerge: false, lazyUpdate: true, silent: true });
    }

    // æ–‡ä»¶åæ¸…æ´—ï¼šWindows ä¸å…è®¸å‡ºç° \ / : * ? " < > |
    function sanitizeFilename(name) {
        return String(name || '')
            .replace(/[\\/:*?"<>|]/g, '_')
            .replace(/\s+/g, ' ')
            .trim();
    }

    function formatTsCompact(d) {
        const dt = (d instanceof Date) ? d : new Date(d || Date.now());
        const pad = (n) => String(n).padStart(2, '0');
        return `${dt.getFullYear()}${pad(dt.getMonth() + 1)}${pad(dt.getDate())}_${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}`;
    }

    // æ•…éšœå¿«ç…§äº‹ä»¶APIä½¿ç”¨æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼šYYYY-MM-DD HH:MM:SS
    // ç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆAsia/Shanghaiï¼‰ï¼Œé¿å…æµè§ˆå™¨æœ¬åœ°æ—¶åŒºå¯¼è‡´â€œå·®8å°æ—¶/å·®7å°æ—¶â€
    function formatDateTimeForSnapshot(dt) {
        const d = (dt instanceof Date) ? dt : new Date(dt || Date.now());
        const parts = new Intl.DateTimeFormat('zh-CN', {
            timeZone: 'Asia/Shanghai',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).formatToParts(d);

        const map = {};
        parts.forEach(p => { map[p.type] = p.value; });
        return `${map.year}-${map.month}-${map.day} ${map.hour}:${map.minute}:${map.second}`;
    }

    // è·³è½¬åˆ°â€œæ•…éšœå¿«ç…§â€å¹¶è‡ªåŠ¨å®šä½äº‹ä»¶ï¼ˆdevice_id + fault_code + timestampï¼‰
    function jumpToFaultSnapshot(fault) {
        if (!fault) return;
        const deviceId = fault.device_id || '';
        const faultCode = fault.fault_code || '';
        if (!deviceId || !faultCode || faultCode === 'E00') {
            alert('è¯¥è®°å½•æ²¡æœ‰å¯ç”¨çš„æ•…éšœå¿«ç…§ä¿¡æ¯');
            return;
        }

        // /api/faults å·²è¿”å›æœ¬åœ°æ—¶é—´ï¼ˆå¸¦Tï¼‰ï¼Œè¿™é‡Œç»Ÿä¸€æ ¼å¼åŒ–ä¸ºå¿«ç…§äº‹ä»¶çš„æ—¶é—´ä¸²
        const dt = new Date(fault.fault_time || Date.now());
        const timestamp = formatDateTimeForSnapshot(dt);

        const url = `/snapshots?device_id=${encodeURIComponent(deviceId)}&fault_code=${encodeURIComponent(faultCode)}&timestamp=${encodeURIComponent(timestamp)}`;
        // åŒé¡µè·³è½¬ï¼ˆæ›´ç¬¦åˆâ€œç‚¹å‡»è·³è½¬â€ï¼‰
        window.location.href = url;
    }

    // é˜²æ­¢ 2s è½®è¯¢å¯¼è‡´è¯·æ±‚å †ç§¯ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ª /api/faults åœ¨é£
    let _faultsLoadingInFlight = false;

    async function loadFaults() {
        if (_faultsLoadingInFlight) {
            return;
        }
        _faultsLoadingInFlight = true;
        try {
            const tbody = document.getElementById('fault-table-body');

            // ä»…åœ¨â€œé¦–æ¬¡åŠ è½½/å°šæœªæˆåŠŸæ¸²æŸ“è¿‡æ•°æ®â€æ—¶æç¤ºï¼Œé¿å…è½®è¯¢æ—¶è¡¨æ ¼é¢‘ç¹é—ªçƒ
            if (tbody && (!globalFaultData || globalFaultData.length === 0)) {
                const hasLoadingHint = (tbody.textContent || '').includes('åŠ è½½ä¸­');
                if (hasLoadingHint) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-arrow-repeat"></i> æ­£åœ¨è·å–æ•…éšœæ•°æ®...ï¼ˆ8ç§’è¶…æ—¶è‡ªåŠ¨æç¤ºï¼‰
                            </td>
                        </tr>
                    `;
                }
            }

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆç”¨äºåˆ·æ–°åæ¢å¤ï¼‰
            const tableContainer = document.querySelector('.table-responsive');
            const scrollTop = tableContainer ? tableContainer.scrollTop : 0;
            
            // é˜²æ­¢è¯·æ±‚ä¸€ç›´ pending å¯¼è‡´é¡µé¢æ°¸è¿œâ€œè·å–ä¸­â€ï¼šå¢åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ8ç§’ï¼‰
            const controller = new AbortController();
            const timeoutMs = 8000;
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            // åªè·å–æ•°æ®ï¼Œä¸åº”ç”¨ä»»ä½•è¿‡æ»¤ï¼ˆè·å–æ‰€æœ‰æ•°æ®ç”¨äºå®¢æˆ·ç«¯è¿‡æ»¤ï¼‰
            const response = await fetch('/api/faults', {
                method: 'GET',
                // æ˜¾å¼å£°æ˜åŒæºæºå¸¦ Cookieï¼Œé¿å…æŸäº›æµè§ˆå™¨/æ‰©å±•å¯¼è‡´â€œå·²ç™»å½•é¡µé¢ä½† API è¢«å½“æˆæœªç™»å½•â€
                credentials: 'same-origin',
                cache: 'no-store',
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json'
                }
            });
            clearTimeout(timeoutId);

            // å…¸å‹é—®é¢˜ï¼šç™»å½•æ€ä¸¢å¤±/æœªæºå¸¦ Cookie -> 302 è·³è½¬åˆ° /login
            if (response.status === 302 || response.redirected || (response.url && response.url.includes('/login'))) {
                console.warn('[loadFaults] ç™»å½•æ€å¯èƒ½å·²å¤±æ•ˆï¼ŒAPI è¿”å›é‡å®šå‘åˆ°ç™»å½•é¡µ');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="mb-2">
                                    <i class="bi bi-shield-lock"></i> ç™»å½•æ€å·²å¤±æ•ˆï¼Œæ— æ³•è·å–æ•…éšœæ—¥å¿—
                                </div>
                                <a class="btn btn-sm btn-outline-primary" href="/login?next=/faults">é‡æ–°ç™»å½•</a>
                                <button class="btn btn-sm btn-light ms-2" onclick="refreshFaultTable()">é‡è¯•</button>
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            // å¤„ç† HTTP é”™è¯¯ï¼ˆ404, 500 ç­‰ï¼‰
            if (!response.ok) {
                console.error(`[loadFaults] HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                const ct = response.headers.get('content-type') || '';
                let details = '';
                try {
                    details = ct.includes('application/json') ? JSON.stringify(await response.json()) : (await response.text());
                } catch (e) {
                    details = '';
                }

                if (tbody) {
                    const safeDetails = escapeHtml(details || '');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="mb-2">
                                    <i class="bi bi-exclamation-triangle"></i> è·å–æ•…éšœæ—¥å¿—å¤±è´¥ï¼ˆHTTP ${response.status}ï¼‰
                                </div>
                                <div class="small text-muted mb-2">è¯·æ£€æŸ¥æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€ä¸ç½‘ç»œè¿æ¥</div>
                                <button class="btn btn-sm btn-light" onclick="refreshFaultTable()">é‡è¯•</button>
                                ${safeDetails ? `<div class="small text-start mt-3" style="max-height: 180px; overflow:auto; white-space: pre-wrap;">${safeDetails}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                const text = await response.text();
                console.error('[loadFaults] APIè¿”å›éJSONï¼Œå¯èƒ½è¢«ä»£ç†/ç™»å½•é¡µæ›¿æ¢:', text.slice(0, 200));
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="mb-2">
                                    <i class="bi bi-exclamation-triangle"></i> è·å–æ•…éšœæ—¥å¿—å¤±è´¥ï¼ˆè¿”å›æ ¼å¼å¼‚å¸¸ï¼‰
                                </div>
                                <div class="small text-muted mb-2">API æœªè¿”å› JSONï¼Œå¯èƒ½æ˜¯ç™»å½•é¡µ/ä»£ç†é”™è¯¯å¯¼è‡´</div>
                                <button class="btn btn-sm btn-light" onclick="refreshFaultTable()">é‡è¯•</button>
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            const data = await response.json();
            
            // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
            if (!data || typeof data !== 'object') {
                console.error('[loadFaults] APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯:', data);
                return;
            }
            
            // è°ƒè¯•æ—¥å¿—ï¼šæ‰“å°æ¥æ”¶åˆ°çš„æ•…éšœæ•°é‡
            const faultCount = (data.faults || []).length;
            console.log(`[loadFaults] æ¥æ”¶åˆ° ${faultCount} æ¡æ•…éšœè®°å½•`);
            if (faultCount > 0) {
                const latestFault = data.faults[0];
                console.log(`[loadFaults] æœ€æ–°æ•…éšœ: ID=${latestFault.id}, è®¾å¤‡=${latestFault.device_id}, çŠ¶æ€=${latestFault.status}, ç±»å‹=${latestFault.fault_type}`);
                // æ‰“å°æ‰€æœ‰æ•…éšœçš„è®¾å¤‡IDï¼Œç”¨äºè°ƒè¯•
                const deviceIds = data.faults.slice(0, 5).map(f => f.device_id);
                console.log(`[loadFaults] å‰5ä¸ªæ•…éšœçš„è®¾å¤‡ID:`, deviceIds);
            } else {
                console.warn(`[loadFaults] âš ï¸  è­¦å‘Š: APIè¿”å›äº†0æ¡æ•…éšœè®°å½•`);
                console.log(`[loadFaults] å®Œæ•´APIå“åº”:`, JSON.stringify(data, null, 2));
            }
            
            // è·å–å½“å‰æ•…éšœIDé›†åˆ
            const currentFaultIds = new Set((data.faults || []).map(f => f.id));
            
            // æ£€æµ‹æ–°æ•…éšœï¼ˆä»…åœ¨éé¦–æ¬¡åŠ è½½æ—¶ï¼‰
            if (previousFaultIds !== null) {
                currentFaultIds.forEach(faultId => {
                    if (!previousFaultIds.has(faultId)) {
                        // æ‰¾åˆ°æ–°æ•…éšœ
                        const newFault = (data.faults || []).find(f => f.id === faultId);
                        if (newFault) {
                            // åªé€šçŸ¥çœŸæ­£çš„æ–°æ•…éšœï¼ˆpendingçŠ¶æ€ï¼‰ï¼Œé¿å…é€šçŸ¥å·²æ´¾å•çš„æ•…éšœ
                            const faultStatus = newFault.status || 'pending';
                            if (faultStatus === 'pending') {
                                // æ„å»ºæ•…éšœæ¶ˆæ¯
                                const faultTypeName = newFault.fault_type || 'æœªçŸ¥æ•…éšœ';
                                const faultCode = newFault.fault_code || 'E00';
                                const deviceId = newFault.device_id || 'æœªçŸ¥è®¾å¤‡';
                                const message = `å‘ç°æ–°æ•…éšœ: ${faultTypeName} (${faultCode}) - ${deviceId}`;
                                
                                // ä½¿ç”¨ç»Ÿä¸€çš„ç³»ç»Ÿäº‹ä»¶å‘å¸ƒå‡½æ•°
                                if (typeof window.publishSystemEvent === 'function') {
                                    window.publishSystemEvent(message, 'error');
                                } else if (typeof window.addMessageToHistory === 'function') {
                                    window.addMessageToHistory(message, 'fault');
                                    // æ˜¾ç¤ºToasté€šçŸ¥
                                    if (typeof window.showToast === 'function') {
                                        window.showToast(message, 'error');
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // é¦–æ¬¡åŠ è½½ï¼Œåªè®°å½•åŸºçº¿
                previousFaultIds = new Set(currentFaultIds);
            }
            
            // æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•…éšœIDé›†åˆ
            previousFaultIds = new Set(currentFaultIds);
            
            // å­˜å‚¨åŸå§‹æ•°æ®åˆ°å…¨å±€å˜é‡
            globalFaultData = data.faults || [];
            allFaults = globalFaultData;  // ä¿æŒå‘åå…¼å®¹
            
            // æ›´æ–°è®¾å¤‡è¿‡æ»¤å™¨é€‰é¡¹ï¼ˆåŸºäºæ‰€æœ‰æ•°æ®ï¼‰
            updateDeviceFilter(globalFaultData);
            
            // è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼ˆä¼šåº”ç”¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼Œä¿æŒæœç´¢å’Œè¿‡æ»¤çŠ¶æ€ï¼‰
            renderFaultTable();
            
            // ç¡®ä¿è¡¨æ ¼åœ¨æˆåŠŸè·å–æ•°æ®ååˆ·æ–°ï¼ˆå¦‚æœæœ‰ DataTable å®ä¾‹ï¼‰
            if (typeof faultTable !== 'undefined' && faultTable) {
                try {
                    faultTable.clear();
                    faultTable.rows.add(globalFaultData);
                    faultTable.draw();
                    console.log('[loadFaults] DataTable å·²åˆ·æ–°');
                } catch (e) {
                    console.log('[loadFaults] ä½¿ç”¨æ‰‹åŠ¨æ¸²æŸ“ï¼Œé DataTable');
                }
            }
            
            // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆä»…åœ¨æ•°æ®å˜åŒ–æ—¶ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨ï¼‰
            if (tableContainer && scrollTop > 0) {
                // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿DOMå·²æ›´æ–°
                requestAnimationFrame(() => {
                    tableContainer.scrollTop = scrollTop;
                });
            }
        } catch (error) {
            console.error('Failed to load faults:', error);

            // å…³é”®ä¿®å¤ï¼šæŠŠå¼‚å¸¸æ˜ç¡®å±•ç¤ºå‡ºæ¥ï¼ˆå¦åˆ™ç”¨æˆ·åªçœ‹åˆ°â€œè·å–ä¸­â€ï¼‰
            const tbody = document.getElementById('fault-table-body');
            if (tbody) {
                let msg = 'è·å–æ•…éšœæ—¥å¿—å¤±è´¥';
                if (error && (error.name === 'AbortError' || String(error).includes('AbortError'))) {
                    msg = 'è·å–æ•…éšœæ—¥å¿—è¶…æ—¶ï¼ˆ8ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¡ä½/ç½‘ç»œæ˜¯å¦å¯è¾¾';
                }
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <div class="mb-2">
                                <i class="bi bi-wifi-off"></i> ${escapeHtml(msg)}
                            </div>
                            <div class="small text-muted mb-2">å»ºè®®æ‰“å¼€æµè§ˆå™¨ F12 â†’ Network æŸ¥çœ‹ /api/faults æ˜¯å¦ä¸€ç›´ Pending</div>
                            <button class="btn btn-sm btn-light" onclick="refreshFaultTable()">é‡è¯•</button>
                        </td>
                    </tr>
                `;
            }
        } finally {
            _faultsLoadingInFlight = false;
        }
    }

    function updateDeviceFilter(faults) {
        const deviceFilter = document.getElementById('device-filter');
        const devices = [...new Set(faults.map(f => f.device_id))];
        
        // å®‰å…¨ï¼šä½¿ç”¨ DOM API è®¾ç½® optionï¼Œé¿å… device_id ä¸­åŒ…å«ç‰¹æ®Šå­—ç¬¦å¯¼è‡´çš„æ³¨å…¥é—®é¢˜
        deviceFilter.innerHTML = '<option value="">æ‰€æœ‰è®¾å¤‡</option>';
        devices.forEach(device => {
            const opt = document.createElement('option');
            opt.value = String(device ?? '');
            opt.textContent = String(device ?? '');
            deviceFilter.appendChild(opt);
        });
    }

    function renderFaultTable() {
        // è·å–å½“å‰æœç´¢è¯
        const searchInput = document.getElementById('fault-search');
        const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
        
        // è·å–å½“å‰è¿‡æ»¤å™¨å€¼
        const statusFilter = document.getElementById('status-filter').value;
        const deviceFilter = document.getElementById('device-filter').value;
        
        // åº”ç”¨å®¢æˆ·ç«¯è¿‡æ»¤
        const filtered = globalFaultData.filter(fault => {
            // æœç´¢è¿‡æ»¤ï¼šåœ¨ device_id, fault_type, fault_code, location ä¸­æœç´¢
            let matchesSearch = true;
            if (searchTerm) {
                const searchStr = (
                    (fault.device_id || '') + 
                    (fault.fault_type || '') + 
                    (fault.fault_code || '') + 
                    (fault.location || '')
                ).toLowerCase();
                matchesSearch = searchStr.includes(searchTerm);
            }
            
            // çŠ¶æ€è¿‡æ»¤
            let matchesStatus = true;
            if (statusFilter) {
                matchesStatus = fault.status === statusFilter;
            }
            
            // è®¾å¤‡è¿‡æ»¤
            let matchesDevice = true;
            if (deviceFilter) {
                matchesDevice = fault.device_id === deviceFilter;
            }
            
            return matchesSearch && matchesStatus && matchesDevice;
        });

        // ========== å…³é”®æ”¹è¿›ï¼šæ’åºé€»è¾‘ï¼ˆæœªå¤„ç†åœ¨å‰ -> å¤„ç†ä¸­ -> å·²å¤„ç†ï¼›åŒç»„æŒ‰æ—¶é—´æ’åºï¼‰==========
        // è¯´æ˜ï¼šåç«¯ /api/faults é»˜è®¤æ˜¯æŒ‰æ—¶é—´å€’åºè¿”å›ï¼Œä½†å‰ç«¯è¿‡æ»¤åé¡ºåºå¯èƒ½è¢«æ‰“ä¹±ï¼Œ
        // å› æ­¤è¿™é‡Œç»Ÿä¸€åšä¸€æ¬¡æ’åºï¼Œä¿è¯å±•ç¤ºè§„åˆ™ç¨³å®šã€‚
        function normalizeStatus(st) {
            const s = String(st || '').trim().toLowerCase();
            if (s === 'fixed') return 'resolved';
            if (s === 'resolved') return 'resolved';
            if (s === 'processing') return 'processing';
            if (s === 'pending') return 'pending';
            return 'pending';
        }

        function statusRank(st) {
            const s = normalizeStatus(st);
            if (s === 'pending') return 0;      // æœªå¤„ç†
            if (s === 'processing') return 1;   // å¤„ç†ä¸­
            return 2;                           // å·²å¤„ç†ï¼ˆresolvedï¼‰
        }

        function getFaultTimeMs(fault) {
            // ä¼˜å…ˆä½¿ç”¨ fault_timeï¼ˆåç«¯å·²å¸¦ +08:00ï¼‰ï¼Œå¦åˆ™ç”¨ time å­—ç¬¦ä¸²å…œåº•
            const ft = fault && fault.fault_time ? String(fault.fault_time) : '';
            if (ft) {
                const ms = Date.parse(ft);
                if (!Number.isNaN(ms)) return ms;
            }
            const t = fault && fault.time ? String(fault.time) : '';
            if (t) {
                // time æ˜¯åŒ—äº¬æ—¶é—´å±•ç¤ºä¸²ï¼šYYYY-MM-DD HH:MM:SS
                const ms2 = Date.parse(t.replace(' ', 'T') + '+08:00');
                if (!Number.isNaN(ms2)) return ms2;
            }
            return 0;
        }

        filtered.sort((a, b) => {
            const ra = statusRank(a.status);
            const rb = statusRank(b.status);
            if (ra !== rb) return ra - rb;
            // åŒä¸€çŠ¶æ€å†…æŒ‰æ—¶é—´æ’åºï¼šæœ€æ–°åœ¨å‰
            return getFaultTimeMs(b) - getFaultTimeMs(a);
        });
        
        const tbody = document.getElementById('fault-table-body');
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— æ•…éšœè®°å½•</td></tr>';
            return;
        }

        const html = filtered.map(fault => {
            let statusDot, statusText;
            if (fault.status === 'pending') {
                statusDot = '<span style="color: #ef4444;">â—</span>';
                statusText = 'å¾…å¤„ç†';
            } else if (fault.status === 'processing') {
                statusDot = '<span style="color: #3b82f6;">â—</span>';
                statusText = 'å¤„ç†ä¸­';
            } else if (fault.status === 'resolved' || fault.status === 'fixed') {
                statusDot = '<span style="color: #10b981;">â—</span>';
                statusText = 'å·²è§£å†³';
            } else {
                statusDot = '<span style="color: #6b7280;">â—</span>';
                statusText = 'æœªçŸ¥';
            }
            
            // ä¸¥é‡ç¨‹åº¦ï¼šåç«¯å·²è¡¥å…… severityï¼›è¿™é‡Œå†åšä¸€æ¬¡å…œåº•æ¨æ–­ï¼Œé¿å…å†å²æ•°æ®ä»æ˜¾ç¤ºâ€œæœªçŸ¥â€
            const inferredSeverity = (() => {
                const s = String(fault.severity || '').trim().toLowerCase();
                if (s === 'severe' || s === 'major' || s === 'general') return s;
                const code = String(fault.fault_code || '').trim();
                const type = String(fault.fault_type || '');
                if (code === 'E04' || code === 'E05' || type.includes('IGBT') || type.includes('å¼€è·¯') || type.includes('æ¥åœ°')) return 'severe';
                if (code === 'E01' || code === 'E02' || type.includes('äº¤æµçªœå…¥') || type.includes('ç»ç¼˜æ•…éšœ')) return 'major';
                if (code === 'E03' || type.includes('ç”µå®¹')) return 'general';
                return 'general';
            })();

            const severityClass = {
                'severe': 'soft-danger',
                'major': 'soft-warning',
                'general': 'soft-primary'
            }[inferredSeverity] || 'soft-primary';
            
            const severityText = {
                'severe': 'ä¸¥é‡',
                'major': 'ä¸»è¦',
                'general': 'ä¸€èˆ¬'
            }[inferredSeverity] || 'ä¸€èˆ¬';
            
            // åç«¯ fault_time å·²å¸¦ +08:00ï¼Œå‰ç«¯ä»å¼ºåˆ¶æŒ‰åŒ—äº¬æ—¶é—´å±•ç¤ºï¼Œç¡®ä¿ä¸€è‡´
            const faultTime = new Intl.DateTimeFormat('zh-CN', {
                timeZone: 'Asia/Shanghai',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).format(new Date(fault.fault_time));
            
            return `
                <tr>
                    <td>${statusDot} ${statusText}</td>
                    <td><span class="badge badge-${severityClass}">${severityText}</span></td>
                    <td>
                        <strong>${escapeHtml(fault.fault_type || 'æœªçŸ¥æ•…éšœ')}</strong>
                        <br><small class="text-muted">${escapeHtml(fault.device_id || '')}</small>
                    </td>
                    <td>${escapeHtml(fault.location || fault.device_id || '')}</td>
                    <td><small>${faultTime}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showDiagnosis(${fault.id})">
                            <i class="bi bi-eye"></i> è¯¦æƒ…/è¯Šæ–­
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="jumpToFaultSnapshot(allFaults.find(f => f.id === ${fault.id}))" title="è·³è½¬åˆ°æ•…éšœå¿«ç…§">
                            <i class="bi bi-camera"></i> å¿«ç…§
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = html;
    }

    async function showDiagnosis(faultId) {
        const fault = allFaults.find(f => f.id === faultId);
        if (!fault) return;
        
        currentFaultId = faultId;
        currentFault = fault;
        
        // å¡«å……æ•…éšœè¯¦æƒ…
        const faultTimeBj = new Intl.DateTimeFormat('zh-CN', {
            timeZone: 'Asia/Shanghai',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).format(new Date(fault.fault_time));

        const detailsHtml = `
            <div class="mb-3">
                <strong>è®¾å¤‡ID:</strong><br>
                <code class="text-danger">${escapeHtml(fault.device_id || '')}</code>
            </div>
            <div class="mb-3">
                <strong>ä½ç½®:</strong><br>
                ${escapeHtml(fault.location || fault.device_id || '')}
            </div>
            <div class="mb-3">
                <strong>æ•…éšœæ—¶é—´:</strong><br>
                ${faultTimeBj}
            </div>
            <div class="mb-3">
                <strong>æ•…éšœç±»å‹:</strong><br>
                ${escapeHtml(fault.fault_type || 'æœªçŸ¥')}
            </div>
            <div class="mb-3">
                <strong>çŠ¶æ€:</strong><br>
                <span class="badge badge-soft-${fault.status === 'pending' ? 'warning' : fault.status === 'processing' ? 'info' : (fault.status === 'resolved' || fault.status === 'fixed') ? 'success' : 'primary'}">
                    ${fault.status === 'pending' ? 'å¾…å¤„ç†' : fault.status === 'processing' ? 'å¤„ç†ä¸­' : (fault.status === 'resolved' || fault.status === 'fixed') ? 'å·²è§£å†³' : 'æœªçŸ¥'}
                </span>
            </div>
            <div>
                <strong>AIæ¨è:</strong><br>
                <small class="text-muted">${escapeHtml(fault.ai_recommendation || 'æš‚æ— æ¨è')}</small>
            </div>
        `;
        
        document.getElementById('fault-details').innerHTML = detailsHtml;
        
        // æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—æŒ‰é’®
        const dispatchBtn = document.getElementById('dispatch-fault-btn');
        const resolveBtn = document.getElementById('resolve-fault-btn');
        const archivedBtn = document.getElementById('archived-btn');
        
        // é‡ç½®æ‰€æœ‰æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        dispatchBtn.style.display = 'none';
        resolveBtn.style.display = 'none';
        archivedBtn.style.display = 'none';
        
        if (fault.status === 'pending') {
            // å¾…å¤„ç†ï¼šæ˜¾ç¤º"ç¡®è®¤æ´¾å•"æŒ‰é’®
            dispatchBtn.style.display = 'inline-block';
        } else if (fault.status === 'processing') {
            // å¤„ç†ä¸­ï¼šæ˜¾ç¤º"ç»´ä¿®å®Œæˆ"æŒ‰é’®
            resolveBtn.style.display = 'inline-block';
        } else if (fault.status === 'resolved' || fault.status === 'fixed') {
            // å·²è§£å†³ï¼šæ˜¾ç¤º"å·²å½’æ¡£"æŒ‰é’®ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰
            archivedBtn.style.display = 'inline-block';
        }
        
        // åŠ è½½çŸ¥è¯†å›¾è°±
        if (fault.fault_code) {
            await loadKnowledgeGraph(fault.fault_code);
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modalElement = document.getElementById('diagnosisModal');
        const modal = new bootstrap.Modal(modalElement);
        
        // ç­‰å¾…æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤ºåè°ƒæ•´å›¾è¡¨å¤§å°
        modalElement.addEventListener('shown.bs.modal', function handler() {
            if (diagnosisChart) {
                setTimeout(() => {
                    diagnosisChart.resize();
                    applyGraphInitialView();
                }, 200);
            }
            modalElement.removeEventListener('shown.bs.modal', handler);
        });
        
        modal.show();
    }

    async function loadKnowledgeGraph(faultCode) {
        try {
            const response = await fetch(`/api/knowledge_graph/${faultCode}`);
            const data = await response.json();
            
            // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºé‡ç½®
            originalGraphData = JSON.parse(JSON.stringify(data));
            expandedNodes.clear();  // é‡ç½®å·²å±•å¼€èŠ‚ç‚¹è®°å½•
            
            if (!diagnosisChart) {
                diagnosisChart = echarts.init(document.getElementById('diagnosis-graph'));
            }
            
            // æ›´æ–°å›¾è¡¨é…ç½®
            updateGraphOption(data);
            
            // å›¾è¡¨è°ƒæ•´å¤§å°
            diagnosisChart.resize();
            applyGraphInitialView();
            
            // ========== å¼ºåˆ¶ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆåœ¨å›¾è¡¨æ›´æ–°åï¼‰ ==========
            // 1. å…ˆè§£ç»‘æ‰€æœ‰ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            diagnosisChart.off('click');
            
            // 2. ç»‘å®šç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆæ”¯æŒå±•å¼€/æ”¶å›åˆ‡æ¢ï¼‰
            diagnosisChart.on('click', async function(params) {
                console.log("ğŸ”¥ Graph Node Clicked:", params);
                console.log("ğŸ”¥ dataType:", params.dataType);
                console.log("ğŸ”¥ params.data:", params.data);
                console.log("ğŸ”¥ params.name:", params.name);
                
                if (params.dataType === 'node') {
                    const nodeName = params.data.name || params.name;
                    const nodeId = params.data.id || nodeName;
                    console.log(`ğŸ–±ï¸ Clicked: ${nodeName}, LogID: ${currentFaultId}`);
                    
                    // é˜²æ­¢å±•å¼€å‚æ•°èŠ‚ç‚¹ï¼ˆå·²ç»æ˜¯äºŒçº§èŠ‚ç‚¹ï¼‰
                    if (params.data.category === 3 || params.data.category === 'parameter') {
                        console.log("âš ï¸ è·³è¿‡å‚æ•°èŠ‚ç‚¹ï¼ˆå·²ç»æ˜¯äºŒçº§èŠ‚ç‚¹ï¼‰");
                        return;
                    }
                    
                    // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å±•å¼€
                    const isExpanded = expandedNodes.has(nodeId) || expandedNodes.has(nodeName);
                    
                    if (isExpanded) {
                        // å¦‚æœå·²å±•å¼€ï¼Œåˆ™æ”¶å›å­èŠ‚ç‚¹
                        console.log(`ğŸ”„ èŠ‚ç‚¹ ${nodeName} å·²å±•å¼€ï¼Œæ‰§è¡Œæ”¶å›æ“ä½œ`);
                        await collapseNode(nodeId, nodeName);
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰æ•…éšœID
                    if (!currentFaultId) {
                        console.error("âŒ é”™è¯¯: currentFaultId æœªè®¾ç½®");
                        alert("é”™è¯¯ï¼šæ— æ³•è·å–æ•…éšœIDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                        return;
                    }
                    
                    // ç¡®ä¿èŠ‚ç‚¹åç§°æ­£ç¡®ç¼–ç ï¼ˆä½¿ç”¨ encodeURIComponent ä¸€æ¬¡ï¼‰
                    const encodedNodeName = encodeURIComponent(nodeName);
                    const url = `/api/graph/details/${currentFaultId}/${encodedNodeName}`;
                    console.log(`ğŸ“¡ Fetch URL: ${url}`);
                    console.log(`ğŸ“¡ Node Name (åŸå§‹): ${nodeName}`);
                    console.log(`ğŸ“¡ Node Name (ç¼–ç ): ${encodedNodeName}`);
                    
                    try {
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            console.error(`âŒ Fetch å¤±è´¥: ${response.status} ${response.statusText}`);
                            const errorText = await response.text();
                            console.error(`é”™è¯¯è¯¦æƒ…: ${errorText}`);
                            return;
                        }
                        
                        const data = await response.json();
                        console.log("ğŸ“¦ Response:", data);
                        
                        if (data.children && data.children.length > 0) {
                            console.log(`âœ… æ”¶åˆ° ${data.children.length} ä¸ªå­èŠ‚ç‚¹`);
                            await expandNodeWithData(params.data, data.children);
                        } else {
                            console.warn("âš ï¸ No children data found for this node.");
                        }
                    } catch (err) {
                        console.error("âŒ Fetch Error:", err);
                    }
                } else {
                    console.log("âš ï¸ ç‚¹å‡»çš„ä¸æ˜¯èŠ‚ç‚¹ï¼ŒdataType:", params.dataType);
                }
            });
            
            console.log("âœ… çŸ¥è¯†å›¾è°±ç‚¹å‡»äº‹ä»¶å·²ç»‘å®š");
        } catch (error) {
            console.error('Failed to load knowledge graph:', error);
        }
    }

    function updateGraphOption(data) {
        // æ›´æ–°å›¾ä¾‹ï¼ŒåŒ…å«æ–°çš„ç±»åˆ«
        const categories = [
            { name: 'æ•…éšœ', itemStyle: { color: '#ef4444' } },
            { name: 'æ ¹æœ¬åŸå› ', itemStyle: { color: '#f59e0b' } },
            { name: 'è§£å†³æ–¹æ¡ˆ', itemStyle: { color: '#10b981' } },
            { name: 'å‚æ•°', itemStyle: { color: '#93c5fd' } }  // æµ…è“è‰²ç”¨äºäºŒçº§èŠ‚ç‚¹
        ];
        
        diagnosisChart.setOption({
            backgroundColor: 'transparent',
            title: {
                text: 'æ•…éšœè¯Šæ–­çŸ¥è¯†å›¾è°±',
                left: 'center',
                top: 10,
                textStyle: { 
                    fontSize: 18, 
                    fontWeight: 'bold',
                    color: '#1f2937'  // æ·±è‰²æ–‡å­—ï¼Œç™½è‰²èƒŒæ™¯ä¸‹å¯è§
                }
            },
            tooltip: {
                trigger: 'item',
                backgroundColor: '#ffffff',
                borderColor: '#dee2e6',
                borderWidth: 1,
                textStyle: {
                    color: '#1f2937'  // æ·±è‰²æ–‡å­—ï¼Œç™½è‰²èƒŒæ™¯ä¸‹å¯è§
                },
                formatter: function(params) {
                    if (params.dataType === 'node') {
                        let tooltip = `<b>${params.data.name}</b>`;
                        if (params.data.value) {
                            tooltip += `<br/>${params.data.value}`;
                        }
                        if (params.data.description) {
                            tooltip += `<br/><small>${params.data.description}</small>`;
                        }
                        return tooltip;
                    }
                    return '';
                }
            },
            legend: {
                data: ['æ•…éšœ', 'æ ¹æœ¬åŸå› ', 'è§£å†³æ–¹æ¡ˆ', 'å‚æ•°'],
                orient: 'vertical',  // å‚ç›´å¸ƒå±€
                right: 10,  // æ”¾åœ¨å³ä¾§
                top: 60,  // è·ç¦»é¡¶éƒ¨60px
                itemGap: 12,  // å›¾ä¾‹é¡¹é—´è·
                textStyle: {
                    fontSize: 12,
                    color: '#1f2937'  // æ·±è‰²æ–‡å­—ï¼Œç™½è‰²èƒŒæ™¯ä¸‹å¯è§
                }
            },
            series: [{
                type: 'graph',
                layout: 'force',
                force: {
                    repulsion: 2000,
                    edgeLength: [100, 200],
                    gravity: 0.1,
                    layoutAnimation: true
                },
                zoom: DEFAULT_GRAPH_ZOOM,
                center: DEFAULT_GRAPH_CENTER,
                roam: true,
                draggable: true,
                label: {
                    show: true,
                    position: 'right',
                    fontSize: function(params) {
                        // äºŒçº§èŠ‚ç‚¹ä½¿ç”¨è¾ƒå°å­—ä½“
                        return params.data.category === 3 ? 11 : 14;
                    },
                    fontWeight: 'bold',
                    formatter: '{b}',
                    color: '#1f2937'  // æ·±è‰²æ–‡å­—ï¼Œç™½è‰²èƒŒæ™¯ä¸‹å¯è§
                },
                edgeSymbol: ['none', 'arrow'],
                edgeSymbolSize: [0, 10],
                categories: categories,
                lineStyle: {
                    color: 'source',
                    curveness: 0.3,
                    width: 2
                },
                emphasis: {
                    focus: 'adjacency',
                    lineStyle: { width: 4 }
                },
                data: data.nodes || [],
                links: data.links || []
            }]
        });
    }

    async function expandNodeWithData(nodeData, childrenData) {
        const nodeName = nodeData.name;
        const nodeId = nodeData.id || nodeName;
        
        console.log(`[expandNodeWithData] ğŸ”¥ å¼€å§‹å±•å¼€èŠ‚ç‚¹: ${nodeName} (ID: ${nodeId})`);
        console.log(`[expandNodeWithData] æ”¶åˆ° ${childrenData.length} ä¸ªå­èŠ‚ç‚¹æ•°æ®`);
        
        // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å±•å¼€
        if (expandedNodes.has(nodeId) || expandedNodes.has(nodeName)) {
            console.log(`[expandNodeWithData] âš ï¸ èŠ‚ç‚¹ ${nodeName} å·²å±•å¼€ï¼Œè·³è¿‡`);
            return;
        }
        
        try {
            // è·å–å½“å‰å›¾è¡¨æ•°æ®
            const currentOption = diagnosisChart.getOption();
            const currentNodes = currentOption.series[0].data || [];
            const currentLinks = currentOption.series[0].links || [];
            
            console.log(`[expandNodeWithData] å½“å‰å›¾è¡¨èŠ‚ç‚¹æ•°: ${currentNodes.length}, é“¾æ¥æ•°: ${currentLinks.length}`);
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å­èŠ‚ç‚¹ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
            // è¯´æ˜ï¼šä»¥å‰ç”¨ name å»é‡ï¼Œä¼šè¿«ä½¿åç«¯æŠŠäºŒçº§èŠ‚ç‚¹ name æ‹¼æ¥æˆâ€œçˆ¶èŠ‚ç‚¹ï½œxxxâ€ï¼Œ
            // å¯¼è‡´è§†è§‰ä¸Šé‡å¤åˆå†—é•¿ã€‚è¿™é‡Œæ”¹ä¸ºæŒ‰ id å»é‡ï¼ŒäºŒçº§èŠ‚ç‚¹å¯ä»¥ç”¨çŸ­æ ‡é¢˜æ˜¾ç¤ºã€‚
            const existingNodeIds = new Set(currentNodes.map(n => n.id || n.name));
            
            // è·å–çˆ¶èŠ‚ç‚¹çš„ä½ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç”¨äºå®šä½å­èŠ‚ç‚¹
            const parentNode = currentNodes.find(n => (n.id === nodeId) || (n.name === nodeName));
            const baseX = parentNode && parentNode.x !== undefined ? parentNode.x : 0;
            const baseY = parentNode && parentNode.y !== undefined ? parentNode.y : 0;
            
            // åˆ›å»ºæ–°èŠ‚ç‚¹å’Œé“¾æ¥
            const newNodes = [];
            const newLinks = [];
            
            childrenData.forEach((child, index) => {
                // ç”Ÿæˆå”¯ä¸€çš„å­èŠ‚ç‚¹ID
                const childId = `${nodeId}_child_${index}`;

                // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡ ID æ£€æŸ¥ï¼‰
                if (existingNodeIds.has(childId)) {
                    console.log(`[expandNodeWithData] âš ï¸ å­èŠ‚ç‚¹ ${childId} å·²å­˜åœ¨ï¼Œè·³è¿‡`);
                    return;
                }
                
                // åˆ›å»ºå­èŠ‚ç‚¹ï¼ˆäºŒçº§èŠ‚ç‚¹ï¼šè¾ƒå°ï¼Œæµ…è“è‰²ï¼‰
                newNodes.push({
                    id: childId,
                    name: child.name,
                    category: 3,  // 3=å‚æ•°ï¼ˆæµ…è“è‰²ï¼‰
                    symbolSize: 30,  // è¾ƒå°çš„èŠ‚ç‚¹
                    value: child.description || '',
                    description: child.description || '',
                    // ç»™å­èŠ‚ç‚¹ä¸€ä¸ªéšæœºä½†é è¿‘çˆ¶èŠ‚ç‚¹çš„ä½ç½®ï¼Œå¸®åŠ©åŠ›å¯¼å‘å¸ƒå±€
                    x: baseX + (Math.random() - 0.5) * 100,
                    y: baseY + (Math.random() - 0.5) * 100,
                    itemStyle: {
                        color: '#0dcaf0'  // æµ…è“è‰²
                    },
                    label: {
                        show: true,
                        position: 'right',
                        fontSize: 10
                    }
                });
                
                // åˆ›å»ºä»çˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹çš„é“¾æ¥
                newLinks.push({
                    source: nodeId,  // ä½¿ç”¨çˆ¶èŠ‚ç‚¹IDæˆ–åç§°
                    target: childId,  // ä½¿ç”¨å­èŠ‚ç‚¹ID
                    value: 'å‚æ•°',
                    lineStyle: {
                        type: 'dashed',  // è™šçº¿è¡¨ç¤ºäºŒçº§å…³ç³»
                        width: 1,
                        color: '#0dcaf0',  // æµ…è“è‰²
                        curveness: 0.2  // è¾ƒå°çš„å¼¯æ›²åº¦
                    }
                });
            });
            
            if (newNodes.length === 0) {
                console.log(`[expandNodeWithData] âš ï¸ æ‰€æœ‰å­èŠ‚ç‚¹éƒ½å·²å­˜åœ¨ï¼Œæ— éœ€æ·»åŠ `);
                return;
            }
            
            // åˆå¹¶æ–°èŠ‚ç‚¹å’Œé“¾æ¥åˆ°ç°æœ‰æ•°æ®
            const updatedNodes = [...currentNodes, ...newNodes];
            const updatedLinks = [...currentLinks, ...newLinks];
            
            console.log(`[expandNodeWithData] ğŸ“Š å‡†å¤‡æ·»åŠ  ${newNodes.length} ä¸ªæ–°èŠ‚ç‚¹å’Œ ${newLinks.length} ä¸ªæ–°é“¾æ¥`);
            
            // æ›´æ–°å›¾è¡¨ï¼ˆä½¿ç”¨ setOption åˆå¹¶æ•°æ®ï¼Œç¡®ä¿ roam: trueï¼‰
            diagnosisChart.setOption({
                series: [{
                    roam: true,  // ç¡®ä¿å¯ä»¥æ‹–åŠ¨å’Œç¼©æ”¾
                    data: updatedNodes,
                    links: updatedLinks
                }]
            });
            
            // æ ‡è®°èŠ‚ç‚¹å·²å±•å¼€ï¼ˆä½¿ç”¨IDå’Œåç§°åŒé‡æ ‡è®°ï¼‰
            expandedNodes.add(nodeId);
            expandedNodes.add(nodeName);
            
            console.log(`[expandNodeWithData] âœ… æˆåŠŸå±•å¼€èŠ‚ç‚¹ ${nodeName}ï¼Œæ·»åŠ äº† ${newNodes.length} ä¸ªå­èŠ‚ç‚¹`);
            
        } catch (error) {
            console.error('[expandNodeWithData] âŒ å±•å¼€èŠ‚ç‚¹å¤±è´¥:', error);
            console.error('[expandNodeWithData] é”™è¯¯å †æ ˆ:', error.stack);
            alert(`å±•å¼€èŠ‚ç‚¹å¤±è´¥: ${error.message}`);
        }
    }

    // æ”¶å›èŠ‚ç‚¹å‡½æ•°ï¼ˆç§»é™¤å­èŠ‚ç‚¹ï¼‰
    async function collapseNode(nodeId, nodeName) {
        try {
            console.log(`[collapseNode] ğŸ”„ å¼€å§‹æ”¶å›èŠ‚ç‚¹: ${nodeName} (ID: ${nodeId})`);
            
            // è·å–å½“å‰å›¾è¡¨æ•°æ®
            const currentOption = diagnosisChart.getOption();
            const currentNodes = currentOption.series[0].data || [];
            const currentLinks = currentOption.series[0].links || [];
            
            // æ‰¾åˆ°æ‰€æœ‰ä»¥è¯¥èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ID
            const childNodeIds = new Set();
            currentLinks.forEach(link => {
                // æ£€æŸ¥é“¾æ¥çš„sourceæ˜¯å¦æ˜¯å½“å‰èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯IDæˆ–åç§°ï¼‰
                const sourceId = typeof link.source === 'object' ? (link.source.id || link.source.name) : link.source;
                const targetId = typeof link.target === 'object' ? (link.target.id || link.target.name) : link.target;
                
                if ((sourceId === nodeId || sourceId === nodeName) && 
                    targetId && (targetId.includes('_child_') || currentNodes.find(n => (n.id || n.name) === targetId)?.category === 3)) {
                    childNodeIds.add(targetId);
                }
            });
            
            console.log(`[collapseNode] æ‰¾åˆ° ${childNodeIds.size} ä¸ªå­èŠ‚ç‚¹éœ€è¦ç§»é™¤`);
            
            if (childNodeIds.size === 0) {
                console.log(`[collapseNode] âš ï¸ æœªæ‰¾åˆ°å­èŠ‚ç‚¹ï¼Œå¯èƒ½å·²ç»æ”¶å›`);
                // å³ä½¿æ²¡æ‰¾åˆ°å­èŠ‚ç‚¹ï¼Œä¹Ÿæ¸…é™¤å±•å¼€æ ‡è®°
                expandedNodes.delete(nodeId);
                expandedNodes.delete(nodeName);
                return;
            }
            
            // ç§»é™¤æ‰€æœ‰ç›¸å…³çš„å­èŠ‚ç‚¹å’Œé“¾æ¥
            const filteredNodes = currentNodes.filter(node => {
                const nodeIdToCheck = node.id || node.name;
                // ä¿ç•™ä¸æ˜¯å­èŠ‚ç‚¹çš„èŠ‚ç‚¹
                return !childNodeIds.has(nodeIdToCheck);
            });
            
            const filteredLinks = currentLinks.filter(link => {
                const sourceId = typeof link.source === 'object' ? (link.source.id || link.source.name) : link.source;
                const targetId = typeof link.target === 'object' ? (link.target.id || link.target.name) : link.target;
                
                // ç§»é™¤ä»¥å½“å‰èŠ‚ç‚¹ä¸ºsourceçš„é“¾æ¥ï¼Œæˆ–è€…ä»¥å­èŠ‚ç‚¹ä¸ºsource/targetçš„é“¾æ¥
                if ((sourceId === nodeId || sourceId === nodeName) && childNodeIds.has(targetId)) {
                    return false;  // ç§»é™¤çˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹çš„é“¾æ¥
                }
                if (childNodeIds.has(sourceId) || childNodeIds.has(targetId)) {
                    return false;  // ç§»é™¤ä»»ä½•æ¶‰åŠå­èŠ‚ç‚¹çš„é“¾æ¥
                }
                return true;
            });
            
            // æ›´æ–°å›¾è¡¨
            diagnosisChart.setOption({
                series: [{
                    data: filteredNodes,
                    links: filteredLinks
                }]
            });
            
            // æ¸…é™¤å±•å¼€æ ‡è®°
            expandedNodes.delete(nodeId);
            expandedNodes.delete(nodeName);
            
            console.log(`[collapseNode] âœ… æˆåŠŸæ”¶å›èŠ‚ç‚¹ ${nodeName}ï¼Œç§»é™¤äº† ${childNodeIds.size} ä¸ªå­èŠ‚ç‚¹`);
            
        } catch (error) {
            console.error('[collapseNode] âŒ æ”¶å›èŠ‚ç‚¹å¤±è´¥:', error);
            console.error('[collapseNode] é”™è¯¯å †æ ˆ:', error.stack);
            alert(`æ”¶å›èŠ‚ç‚¹å¤±è´¥: ${error.message}`);
        }
    }

    async function expandNode(nodeData) {
        const nodeName = nodeData.name;
        const nodeId = nodeData.id || nodeName;  // ä½¿ç”¨åç§°ä½œä¸ºIDçš„åå¤‡
        
        console.log(`[expandNode] ğŸ”¥ å¼€å§‹å±•å¼€èŠ‚ç‚¹: ${nodeName} (ID: ${nodeId})`);
        
        // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å±•å¼€ï¼ˆä½¿ç”¨IDå’Œåç§°åŒé‡æ£€æŸ¥ï¼‰
        if (expandedNodes.has(nodeId) || expandedNodes.has(nodeName)) {
            console.log(`[expandNode] âš ï¸ èŠ‚ç‚¹ ${nodeName} å·²å±•å¼€ï¼Œè·³è¿‡`);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰æ•…éšœIDï¼ˆå¿…é¡»ä¼ é€’ä»¥è·å–åŠ¨æ€æ•°æ®ï¼‰
        if (!currentFaultId) {
            console.error(`[expandNode] âŒ é”™è¯¯: currentFaultId æœªè®¾ç½®ï¼Œæ— æ³•è·å–åŠ¨æ€æ•°æ®`);
            alert("é”™è¯¯ï¼šæ— æ³•è·å–æ•…éšœIDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            return;
        }
        
        try {
            // è·å–èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°æ®ï¼ˆä¼ é€’æ•…éšœæ—¥å¿—IDä»¥è·å–åŠ¨æ€æ•°æ®ï¼‰
            const encodedNodeName = encodeURIComponent(nodeName);
            const apiUrl = `/api/graph/details/${currentFaultId}/${encodedNodeName}`;
            console.log(`[expandNode] ğŸ“¡ è¯·æ±‚API: ${apiUrl}`);
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                console.error(`[expandNode] âŒ APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error(`[expandNode] é”™è¯¯è¯¦æƒ…: ${errorText}`);
                alert(`è·å–èŠ‚ç‚¹æ•°æ®å¤±è´¥: ${response.status} ${response.statusText}`);
                return;
            }
            
            const details = await response.json();
            console.log(`[expandNode] âœ… æ”¶åˆ°APIå“åº”:`, details);
            console.log(`[expandNode] å­èŠ‚ç‚¹æ•°é‡:`, details.children ? details.children.length : 0);
            
            if (!details.children || details.children.length === 0) {
                console.log(`[expandNode] âš ï¸ èŠ‚ç‚¹ ${nodeName} æ²¡æœ‰å­èŠ‚ç‚¹`);
                return;
            }
            
            // è·å–å½“å‰å›¾è¡¨æ•°æ®
            const currentOption = diagnosisChart.getOption();
            const currentNodes = currentOption.series[0].data || [];
            const currentLinks = currentOption.series[0].links || [];
            
            console.log(`[expandNode] å½“å‰å›¾è¡¨èŠ‚ç‚¹æ•°: ${currentNodes.length}, é“¾æ¥æ•°: ${currentLinks.length}`);
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å­èŠ‚ç‚¹ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
            const existingNodeNames = new Set(currentNodes.map(n => n.name));
            
            // è·å–çˆ¶èŠ‚ç‚¹çš„ä½ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç”¨äºå®šä½å­èŠ‚ç‚¹
            const parentNode = currentNodes.find(n => (n.id === nodeId) || (n.name === nodeName));
            const baseX = parentNode && parentNode.x !== undefined ? parentNode.x : 0;
            const baseY = parentNode && parentNode.y !== undefined ? parentNode.y : 0;
            
            // åˆ›å»ºæ–°èŠ‚ç‚¹å’Œé“¾æ¥
            const newNodes = [];
            const newLinks = [];
            
            details.children.forEach((child, index) => {
                // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡åç§°æ£€æŸ¥ï¼‰
                if (existingNodeNames.has(child.name)) {
                    console.log(`[expandNode] âš ï¸ å­èŠ‚ç‚¹ ${child.name} å·²å­˜åœ¨ï¼Œè·³è¿‡`);
                    return;  // è·³è¿‡å·²å­˜åœ¨çš„èŠ‚ç‚¹
                }
                
                // ç”Ÿæˆå”¯ä¸€çš„å­èŠ‚ç‚¹ID
                const childId = `${nodeId}_child_${index}`;
                
                // åˆ›å»ºå­èŠ‚ç‚¹ï¼ˆäºŒçº§èŠ‚ç‚¹ï¼šè¾ƒå°ï¼Œæµ…è“è‰²ï¼‰
                newNodes.push({
                    id: childId,
                    name: child.name,
                    category: 3,  // 3=å‚æ•°ï¼ˆæµ…è“è‰²ï¼‰
                    symbolSize: 30,  // è¾ƒå°çš„èŠ‚ç‚¹
                    value: child.description || '',
                    description: child.description || '',
                    // ç»™å­èŠ‚ç‚¹ä¸€ä¸ªéšæœºä½†é è¿‘çˆ¶èŠ‚ç‚¹çš„ä½ç½®ï¼Œå¸®åŠ©åŠ›å¯¼å‘å¸ƒå±€
                    x: baseX + (Math.random() - 0.5) * 100,
                    y: baseY + (Math.random() - 0.5) * 100,
                    itemStyle: {
                        color: '#0dcaf0'  // æµ…è“è‰²
                    },
                    label: {
                        show: true,
                        position: 'right',
                        fontSize: 10
                    }
                });
                
                // åˆ›å»ºä»çˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹çš„é“¾æ¥
                newLinks.push({
                    source: nodeId,  // ä½¿ç”¨çˆ¶èŠ‚ç‚¹IDæˆ–åç§°
                    target: childId,  // ä½¿ç”¨å­èŠ‚ç‚¹ID
                    value: 'å‚æ•°',
                    lineStyle: {
                        type: 'dashed',  // è™šçº¿è¡¨ç¤ºäºŒçº§å…³ç³»
                        width: 1,
                        color: '#0dcaf0',  // æµ…è“è‰²
                        curveness: 0.2  // è¾ƒå°çš„å¼¯æ›²åº¦
                    }
                });
            });
            
            if (newNodes.length === 0) {
                console.log(`[expandNode] âš ï¸ æ‰€æœ‰å­èŠ‚ç‚¹éƒ½å·²å­˜åœ¨ï¼Œæ— éœ€æ·»åŠ `);
                return;
            }
            
            // åˆå¹¶æ–°èŠ‚ç‚¹å’Œé“¾æ¥åˆ°ç°æœ‰æ•°æ®
            const updatedNodes = [...currentNodes, ...newNodes];
            const updatedLinks = [...currentLinks, ...newLinks];
            
            console.log(`[expandNode] ğŸ“Š å‡†å¤‡æ·»åŠ  ${newNodes.length} ä¸ªæ–°èŠ‚ç‚¹å’Œ ${newLinks.length} ä¸ªæ–°é“¾æ¥`);
            
            // æ›´æ–°å›¾è¡¨ï¼ˆä½¿ç”¨ setOption åˆå¹¶æ•°æ®ï¼‰
            diagnosisChart.setOption({
                series: [{
                    data: updatedNodes,
                    links: updatedLinks
                }]
            });
            
            // æ ‡è®°èŠ‚ç‚¹å·²å±•å¼€ï¼ˆä½¿ç”¨IDå’Œåç§°åŒé‡æ ‡è®°ï¼‰
            expandedNodes.add(nodeId);
            expandedNodes.add(nodeName);
            
            console.log(`[expandNode] âœ… æˆåŠŸå±•å¼€èŠ‚ç‚¹ ${nodeName}ï¼Œæ·»åŠ äº† ${newNodes.length} ä¸ªå­èŠ‚ç‚¹`);
            
        } catch (error) {
            console.error('[expandNode] âŒ å±•å¼€èŠ‚ç‚¹å¤±è´¥:', error);
            console.error('[expandNode] é”™è¯¯å †æ ˆ:', error.stack);
            alert(`å±•å¼€èŠ‚ç‚¹å¤±è´¥: ${error.message}`);
        }
    }

    function resetKnowledgeGraph() {
        if (originalGraphData && diagnosisChart) {
            // é‡ç½®ä¸ºåŸå§‹æ•°æ®
            updateGraphOption(originalGraphData);
            expandedNodes.clear();
            console.log('çŸ¥è¯†å›¾è°±å·²é‡ç½®ä¸ºåˆå§‹è§†å›¾');
        }
    }

    async function exportWorkOrder() {
        if (!currentFaultId) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•…éšœè®°å½•');
            return;
        }
        
        try {
            // 1. å°è¯•æ•è·çŸ¥è¯†å›¾è°±å›¾è¡¨å›¾ç‰‡
            let graphImageBase64 = null;
            
            if (diagnosisChart) {
                try {
                    // è·å–å›¾è¡¨çš„Base64å›¾ç‰‡æ•°æ®
                    graphImageBase64 = diagnosisChart.getDataURL({
                        type: 'png',
                        pixelRatio: 2,
                        backgroundColor: '#fff'
                    });
                    console.log('çŸ¥è¯†å›¾è°±å›¾ç‰‡å·²æ•è·');
                } catch (chartError) {
                    console.warn('æ— æ³•æ•è·çŸ¥è¯†å›¾è°±å›¾ç‰‡:', chartError);
                    // ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿æ²¡æœ‰å›¾ç‰‡ä¹Ÿèƒ½å¯¼å‡ºæ–‡æ¡£
                }
            } else {
                console.warn('çŸ¥è¯†å›¾è°±å›¾è¡¨æœªåŠ è½½ï¼Œå°†å¯¼å‡ºä¸å«å›¾è¡¨çš„æ–‡æ¡£');
            }
            
            // 2. å‘é€POSTè¯·æ±‚ï¼ŒåŒ…å«å›¾è¡¨å›¾ç‰‡æ•°æ®
            const csrfToken = getCsrfToken();
            const response = await fetch('/api/workorder/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                },
                body: JSON.stringify({
                    log_id: currentFaultId,
                    graph_image: graphImageBase64
                })
            });
            
            if (!response.ok) {
                // å…¼å®¹ï¼šåç«¯å¯èƒ½è¿”å› HTMLï¼ˆä¾‹å¦‚ç™»å½•å¤±æ•ˆè¢«é‡å®šå‘ï¼‰ï¼Œæ­¤æ—¶ response.json() ä¼šæŠ›é”™
                let msg = 'å¯¼å‡ºå¤±è´¥';
                const ct = (response.headers.get('Content-Type') || '').toLowerCase();
                if (ct.includes('application/json')) {
                    const errorData = await response.json();
                    msg = errorData.error || errorData.message || msg;
                } else {
                    const text = await response.text();
                    if (text && text.toLowerCase().includes('<!doctype')) {
                        msg = 'ç™»å½•çŠ¶æ€å¯èƒ½å·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡æ–°ç™»å½•å†å¯¼å‡º';
                    }
                }
                throw new Error(msg);
            }
            
            // 3. å¤„ç†ä¸‹è½½ï¼ˆPOSTè¯·æ±‚éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼‰
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // ä¼˜å…ˆï¼šä½¿ç”¨â€œå½“å‰æ•…éšœä¿¡æ¯â€æœ¬åœ°ç”Ÿæˆä¸­æ–‡æ–‡ä»¶åï¼ˆæœ€ç¨³ï¼Œä¸ä¾èµ–å“åº”å¤´è§£æï¼‰
            // è¯´æ˜ï¼šéƒ¨åˆ†æµè§ˆå™¨/ä¸‹è½½å™¨å¯¹ Content-Disposition çš„ filename*/ä¸­æ–‡è§£æå¹¶ä¸ä¸€è‡´ï¼Œ
            // æœ¬åœ°ç”Ÿæˆå¯ä»¥ç¡®ä¿æœ€ç»ˆä¸‹è½½åä¸€å®šåŒ…å«ä¸­æ–‡è®¾å¤‡åç§°ã€‚
            const deviceName = sanitizeFilename(currentFault?.device_id || 'è®¾å¤‡');
            const faultTypeName = sanitizeFilename(currentFault?.fault_type || 'æ•…éšœ');
            const tsLocal = formatTsCompact(currentFault?.fault_time);
            let filename = sanitizeFilename(`å·¥å•_${deviceName}_${faultTypeName}_ID${currentFaultId}_${tsLocal}.docx`) || 'å·¥å•.docx';

            // æ¬¡é€‰ï¼šä»å“åº”å¤´è·å–æ–‡ä»¶åï¼ˆä¼˜å…ˆä¸­æ–‡ï¼‰ï¼Œç”¨äºåç«¯è‡ªå®šä¹‰æ ¼å¼æ—¶è¦†ç›–æœ¬åœ°å
            // è¯´æ˜ï¼š
            // - filename*ï¼ˆRFC 5987ï¼‰æ”¯æŒ UTF-8
            // - X-EdgeWind-Filename æ˜¯åç«¯æä¾›çš„ URL ç¼–ç ä¸­æ–‡æ–‡ä»¶åï¼ˆASCII å®‰å…¨ï¼‰ï¼Œç”¨äºå…¼å®¹éƒ¨åˆ†ç¯å¢ƒ
            const encodedCnName = response.headers.get('X-EdgeWind-Filename');
            const contentDisposition = response.headers.get('Content-Disposition');

            if (encodedCnName) {
                try {
                    filename = sanitizeFilename(decodeURIComponent(encodedCnName)) || filename;
                } catch (e) {
                    console.warn('è§£æ X-EdgeWind-Filename å¤±è´¥ï¼Œå°†å›é€€åˆ° Content-Disposition:', e);
                }
            }

            // åªåœ¨â€œæ²¡æ‹¿åˆ°ä¸­æ–‡åâ€çš„æƒ…å†µä¸‹å†å°è¯•è§£æ Content-Dispositionï¼ˆé¿å…å›é€€åˆ° ASCII æ–‡ä»¶åè¦†ç›–æœ¬åœ°ä¸­æ–‡åï¼‰
            if ((!filename || filename === 'å·¥å•.docx') && contentDisposition) {
                // å…ˆè§£æ filename*ï¼ˆUTF-8''...ï¼‰
                const fnStar = contentDisposition.match(/filename\*\s*=\s*([^;]+)/i);
                if (fnStar && fnStar[1]) {
                    const v = fnStar[1].trim().replace(/^UTF-8''/i, '').replace(/^['"]|['"]$/g, '');
                    try {
                        filename = sanitizeFilename(decodeURIComponent(v)) || filename;
                    } catch (e) {
                        console.warn('è§£æ filename* å¤±è´¥ï¼Œå°†å°è¯•è§£æ filename=:', e);
                    }
                }

                // å†å›é€€è§£æ filename=
                // æ³¨æ„ï¼šfilename= å¯èƒ½æ˜¯ ASCII å›é€€åï¼Œè¿™é‡Œåªåœ¨ç¡®å®æ²¡æœ‰ä¸­æ–‡åå¯ç”¨æ—¶æ‰ç”¨å®ƒ
                if ((!filename || filename === 'å·¥å•.docx')) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/i);
                    if (filenameMatch && filenameMatch[1]) {
                        const fallback = filenameMatch[1].replace(/['"]/g, '').trim();
                        filename = sanitizeFilename(fallback) || filename;
                    }
                }
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            console.log('å·¥å•å¯¼å‡ºæˆåŠŸ');
        } catch (error) {
            console.error('å¯¼å‡ºå·¥å•å¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
    }

    async function dispatchFault(faultId) {
        if (!faultId) {
            alert('é”™è¯¯ï¼šæ— æ³•è·å–æ•…éšœID');
            return;
        }
        
        try {
            const csrfToken = getCsrfToken();
            const response = await fetch(`/api/faults/${faultId}/dispatch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                const dispatchBtn = document.getElementById('dispatch-fault-btn');
                const resolveBtn = document.getElementById('resolve-fault-btn');
                dispatchBtn.style.display = 'none';
                resolveBtn.style.display = 'inline-block';
                
                // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                const statusBadge = document.querySelector('#fault-details .badge');
                if (statusBadge) {
                    statusBadge.className = 'badge badge-soft-info';
                    statusBadge.textContent = 'å¤„ç†ä¸­';
                }
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('diagnosisModal'));
                modal.hide();
                
                // é‡æ–°åŠ è½½æ•…éšœåˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                await loadFaults();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert('æ´¾å•æˆåŠŸï¼æ•…éšœçŠ¶æ€å·²æ›´æ–°ä¸º"å¤„ç†ä¸­"ã€‚');
            } else {
                alert(`æ´¾å•å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (error) {
            console.error('æ´¾å•è¯·æ±‚å¤±è´¥:', error);
            alert('æ´¾å•å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        }
    }

    async function resolveFault(faultId) {
        if (!faultId) {
            alert('é”™è¯¯ï¼šæ— æ³•è·å–æ•…éšœID');
            return;
        }
        
        if (!confirm('ç¡®è®¤ç»´ä¿®å·²å®Œæˆï¼Ÿæ­¤æ“ä½œå°†æ ‡è®°æ•…éšœä¸º"å·²è§£å†³"å¹¶é‡ç½®è®¾å¤‡çŠ¶æ€ä¸ºæ­£å¸¸ã€‚')) {
            return;
        }
        
        try {
            const csrfToken = getCsrfToken();
            const response = await fetch(`/api/faults/${faultId}/resolve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                const resolveBtn = document.getElementById('resolve-fault-btn');
                const archivedBtn = document.getElementById('archived-btn');
                resolveBtn.style.display = 'none';
                archivedBtn.style.display = 'inline-block';
                
                // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                const statusBadge = document.querySelector('#fault-details .badge');
                if (statusBadge) {
                    statusBadge.className = 'badge badge-soft-success';
                    statusBadge.textContent = 'å·²è§£å†³';
                }
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('diagnosisModal'));
                modal.hide();
                
                // é‡æ–°åŠ è½½æ•…éšœåˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                await loadFaults();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert('ç»´ä¿®å®Œæˆï¼æ•…éšœå·²æ ‡è®°ä¸º"å·²è§£å†³"ï¼Œå¤ä½æŒ‡ä»¤å·²ä¸‹å‘åˆ°è®¾å¤‡ã€‚è®¾å¤‡å°†åœ¨ä¸‹æ¬¡å¿ƒè·³æ—¶è‡ªåŠ¨å¤ä½ä¸ºæ­£å¸¸çŠ¶æ€ã€‚');
            } else {
                alert(`æ“ä½œå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (error) {
            console.error('è§£å†³æ•…éšœè¯·æ±‚å¤±è´¥:', error);
            alert('æ“ä½œå¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        }
    }

    // ========== åˆ·æ–°è¡¨æ ¼å‡½æ•° ==========
    function refreshFaultTable() {
        loadFaults();
    }

    // ========== å¯¼å‡ºæ•°æ®å‡½æ•° ==========
    function exportData() {
        // å¯¼å‡ºå½“å‰æ˜¾ç¤ºçš„æ•…éšœæ•°æ®ï¼ˆåº”ç”¨äº†è¿‡æ»¤åçš„æ•°æ®ï¼‰
        const filtered = globalFaultData.filter(fault => {
            const searchInput = document.getElementById('fault-search');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            const statusFilter = document.getElementById('status-filter').value;
            const deviceFilter = document.getElementById('device-filter').value;
            
            let matchesSearch = true;
            if (searchTerm) {
                const searchStr = (
                    (fault.device_id || '') + 
                    (fault.fault_type || '') + 
                    (fault.fault_code || '') + 
                    (fault.location || '')
                ).toLowerCase();
                matchesSearch = searchStr.includes(searchTerm);
            }
            
            const matchesStatus = !statusFilter || fault.status === statusFilter;
            const matchesDevice = !deviceFilter || fault.device_id === deviceFilter;
            
            return matchesSearch && matchesStatus && matchesDevice;
        });
        
        if (filtered.length === 0) {
            alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
            return;
        }
        
        // ç”ŸæˆCSVå†…å®¹
        let csvContent = 'çŠ¶æ€,ä¸¥é‡ç¨‹åº¦,æ•…éšœæè¿°,æœºç»„,æ—¶é—´,æ•…éšœä»£ç \n';
        filtered.forEach(fault => {
            const status = fault.status === 'pending' ? 'å¾…å¤„ç†' : 
                          fault.status === 'processing' ? 'å¤„ç†ä¸­' : 'å·²è§£å†³';
            const sevRaw = String(fault.severity || '').trim().toLowerCase();
            const severity = sevRaw === 'severe' ? 'ä¸¥é‡' :
                            sevRaw === 'major' ? 'ä¸»è¦' :
                            sevRaw === 'general' ? 'ä¸€èˆ¬' : 'ä¸€èˆ¬';
            const time = new Intl.DateTimeFormat('zh-CN', {
                timeZone: 'Asia/Shanghai',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).format(new Date(fault.fault_time));
            csvContent += `${status},${severity},"${fault.fault_type}",${fault.device_id},${time},${fault.fault_code || ''}\n`;
        });
        
        // ä¸‹è½½CSVæ–‡ä»¶
        // 1. Get current time (åŒ—äº¬æ—¶é—´)
        const now = new Date();
        const nowBj = formatDateTimeForSnapshot(now); // YYYY-MM-DD HH:MM:SS
        const dateStr = nowBj.split(' ')[0];
        const timeStr = nowBj.split(' ')[1].replace(/:/g, '-'); // e.g., "14-30-05"
        
        // 2. Generate Filename with Timestamp
        const filename = `æ•…éšœæ—¥å¿—_${dateStr}_${timeStr}.csv`;
        
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // æœç´¢å’Œè¿‡æ»¤äº‹ä»¶ç›‘å¬å™¨
    // æœç´¢æ¡†è¾“å…¥äº‹ä»¶ï¼šç«‹å³è§¦å‘å®¢æˆ·ç«¯è¿‡æ»¤
    document.getElementById('fault-search').addEventListener('input', function(e) {
        renderFaultTable();  // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼ˆåº”ç”¨æœç´¢è¿‡æ»¤ï¼‰
    });

    // çŠ¶æ€è¿‡æ»¤å™¨å˜åŒ–äº‹ä»¶ï¼šè§¦å‘å®¢æˆ·ç«¯è¿‡æ»¤
    document.getElementById('status-filter').addEventListener('change', function() {
        renderFaultTable();  // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼ˆåº”ç”¨çŠ¶æ€è¿‡æ»¤ï¼‰
    });

    // è®¾å¤‡è¿‡æ»¤å™¨å˜åŒ–äº‹ä»¶ï¼šè§¦å‘å®¢æˆ·ç«¯è¿‡æ»¤
    document.getElementById('device-filter').addEventListener('change', function() {
        renderFaultTable();  // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼ˆåº”ç”¨è®¾å¤‡è¿‡æ»¤ï¼‰
    });
    document.getElementById('dispatch-fault-btn').addEventListener('click', function() {
        if (currentFaultId) {
            dispatchFault(currentFaultId);
        }
    });
    document.getElementById('resolve-fault-btn').addEventListener('click', function() {
        if (currentFaultId) {
            resolveFault(currentFaultId);
        }
    });

    // ========== å¤„ç†URLå‚æ•°ï¼ˆä»å…¨å±€æœç´¢è·³è½¬ï¼‰ ==========
    function handleURLParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search');
        
        if (searchQuery) {
            const searchInput = document.getElementById('fault-search');
            if (searchInput) {
                // é¢„å¡«å……æœç´¢æ¡†
                searchInput.value = searchQuery;
                // è§¦å‘è¿‡æ»¤ï¼ˆç­‰å¾…æ•°æ®åŠ è½½å®Œæˆï¼‰
                setTimeout(() => {
                    renderFaultTable();
                }, 500);
                // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æœç´¢
                window.history.replaceState({}, '', '/faults');
            }
        }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // é¦–æ¬¡åŠ è½½æ•°æ®
        loadFaults();
        
        // å¤„ç†URLå‚æ•°ï¼ˆå…¨å±€æœç´¢è·³è½¬ï¼‰
        handleURLParams();
        
        // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆä½†ä¿æŒå½“å‰çš„è¿‡æ»¤çŠ¶æ€å’Œæ»šåŠ¨ä½ç½®ï¼‰
        // ä¿®å¤ï¼šä½¿ç”¨2000msè½®è¯¢é—´éš”ï¼Œç¡®ä¿æ•…éšœæ—¥å¿—å®æ—¶æ›´æ–°ï¼ˆé™ä½æœåŠ¡å™¨è´Ÿè½½ï¼‰
        const pollingInterval = 2000;  // 2ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ•…éšœæ—¥å¿—å®æ—¶æ›´æ–°
        
        // å¼€å§‹å®šæ—¶åˆ·æ–°ï¼ˆä¿æŒå½“å‰çš„è¿‡æ»¤çŠ¶æ€å’Œæ»šåŠ¨ä½ç½®ï¼‰
        const refreshInterval = setInterval(loadFaults, pollingInterval);
        
        // è°ƒè¯•æ—¥å¿—ï¼šç¡®è®¤è½®è¯¢å·²å¯åŠ¨
        console.log(`[Faultsé¡µé¢] æ•…éšœæ—¥å¿—è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”: ${pollingInterval}ms`);
        
        // å“åº”å¼
        window.addEventListener('resize', function() {
            if (diagnosisChart) {
                diagnosisChart.resize();
            }
        });
    });
</script>
{% endblock %}
